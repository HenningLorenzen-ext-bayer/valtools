---
title: "Starting New Validation Package using {valtools}"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Starting New Validation Package using {valtools}}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
)
```

```{r setup, warning=FALSE}
# remotes::install_github("phuse-org/valtools")
library(valtools)
```

This vignette steps through the process of creating an R package that is intended to be 
validated, by extending `usethis` and `devtools` functionality to provide a 
seamless validation process. 

- Create a new R package skeleton
- Add requirements
- Package development
- Change log
- Add test cases
- Add test code

### Starting a Package


```{r}

# create a new package skeleton
vt_create_package(file.path(tempdir(),"example.package"))

```

See how in addition to the normal R package infrastructure, there is now a 
`vignettes/validation` folder, which is the working directory for the 
validation. Inside this, there is a `validation.yml` file. This file is the 
configuration file for validation. It drives a lot of the downstream steps that 
occur during validation.

```{r}

fs::dir_tree(recurse = TRUE)

cat(readLines("vignettes/validation/validation.yml"),sep = "\n")

```


## Requirements

To add the content required for validation, we extended the `usethis` process to
create a family of "vt_use_*" functions.

`vt_use_req()` creates a new requirement. It accepts the name of the requirement, 
and optionally a username. If not passed, {valtools} will automatically get the username
of the person creating the requirement. If the user has not created any contents 
before, it will ask the user some questions (Name, Title, and Role) and record
them in `validation.yml` for documentation in the validation report.

```{r}

valtools::vt_use_req("Requirement_001")

```

In the newly opened requirements file, on line 5, Replace `REQUIREMENTS` with `1.1`, and `ASSESSMENT` with `1, Low Risk, Small Impact` to indicate requirement 1.1 has a risk assessment that determined it has a low risk and small impact when it is wrong.

Add a new line underneath the line above (at line 6) line that contains:
`#' 1.2: 5, Low risk, Medium Impact`

Copy the following content:

```
## Say Hello

+ 1.1 Say Hello to users
+ 1.2 Say Hello to multiple users at once

```

## Package development

At this point, step back into the usual R package development process using 
`usethis` and `devtools` to create the package.

One unique step is to use the custom `@editor` and `@editDate` roxygen tags to 
mark who wrote a function and who edited it last.


```{r function}

usethis::use_r("hello_world")

```

Copy the following code

```r
#' Hello World
#' @param name name to say hello to
#' @returns character string saying hello
#' @editor Ellis Hughes
#' @editDate 2021-03-12
#' @export
hello_world <- function(name){
  paste("Hello,",name)
}

#' Hello World - internal
#' @param name name to say hello to
#' @returns character string saying hello
#' @editor Ellis Hughes
#' @editDate 2021-03-12
hello_world_internal <- function(name){
  paste("hello,",name)
}

```

```{r}

# generate documentation
devtools::document()

#GPP: unit testing, update DESCRIPTION, ...
```

## Change log

Updates and changes in validation documentation are documented using the Change Log file.

```{r}

valtools::vt_use_change_log()

```

Change lots are useful for summarizing changes that have been made to the validation
code or requirements and act as a way to pass information to leadership to help answer 
high level questions.

## Testing

### Test Cases

`vt_use_test_case()` creates a new test case file, and `vt_use_test_code()` 
creates a new test code file. They have the same arguments as `vt_use_req()`.

```{r}

valtools::vt_use_test_case("Test_case_001")

```


Replace `TESTCASE` with `1.1`, and `REQUIREMENT` with `1.1` to indicate test case 1.1 shows that requirement 1.1 is being met.


Add a new line underneath the line above (at line 6) line that contains:
`#' 1.2: 1.1, 1.2`

This is to indicate test case 1.2 shows requirements 1.1 and 1.2 are being met.

Copy the following test case into file where test cases are to be documented:

```
## Test Case 1: hello_world

+ 1.1 test that the software can say "hello, Johnny" by passing a user "Johnny" 
to the hello_world function
+ 1.2 test that the software can say hello to multiple people by passing a vector of users - "Johnny", "Beth", "Andy","Elisabeth"
to the hello_world function and getting back a vector of: c("Hello, Johnny", "Hello, Beth", "Hello, Andy","Hello, Elisabeth")
```

### Test Code

Test code is done by a third party - someone that was not involved with writing the 
actual code or the test case that needs to be converted into code. 

Add this person into the documentation of the package via `vt_add_user_to_config()`.

```{r}

valtools::vt_add_user_to_config(
  username = "user_b",
  name = "Val A Dashun",
  title = "Programmer II",
  role = "tester"
)

```

Now that this persons information is recorded, construct the test code
file that they will use to record the test code through the code below. 

```{r}

valtools::vt_use_test_code("Test_code_001", username = "Val A Dashun")

```

Alternatively, this person could run `vt_use_test_code()`, and it will behave just like 
`vt_use_req()` and add the users information automatically.

Update `TESTNUMBER` to `1.1` in the new test code file and copy the code below
into the body of the test:

```r

 hello_result <- hello_world("Johnny")
 
 expect_equal(
  hello_result,
  "Hello, Johnny"
 )

```
add a new test with the following beneath the test. Replace "TODAYS DATE" with todays date.

```r

#' @editor Val A Dashun
#' @editDate TODAYS DATE
test_that("1.2",{

 hello_result <- hello_world(c("Johnny", "Beth", "Andy","Elisabeth"))
 
 expect_equal(
  hello_result,
  c("Hello, Johnny", "Hello, Beth", "Hello, Andy","Hello, Elisabeth")
 )
})


```

## Generating the Validation Report

`vt_use_report()` is used to create the validation report rmarkdown. This is 
populated in the working directory specified in `validation.yml`, which for
packages defaults to the `vignettes`, and creates a template based on the 
report Rmd name specified in `validation.yml`, which defaults to `validation.Rmd`.


```{r}
valtools::vt_use_report(template = "validation")
```

There are several sections included by default in the base template. 

- Signatures: Capture signatures of everyone involved in the validation.
- Release Details: 
    - Records the validation environment
    - Presents the change log of the validation.
    - Subsections to show the last editor for each piece of the validation; requirements, functions, test cases and test code.
    - Traceability table to show which requirements are being
    - Risk Assessment: Combines all the risk assessments made into a single table
- Validation: record each requirement, testcase and results of the test code
    
{valtools} also supports a concept called "dynamic referencing", which will be explained in another vignette.


When editing the report, some key functions to know for extending the report included by {valtools} are:

  - `vt_path()` allows user to base path from the validation directory. Similar idea to the {here} package, but for validation.
  - `vt_file()` allows the user to point to specific files and render them as child documents within the report.
  - `vt_scrape_*` family of functions allows users to scrape various pieces of information from the validation infrastructure and returns a data.frame.
  - `vt_kable_*` family functions provides an opinionated formatting to the `vt_scrape_*` functions to help quickly construct 
      the report.
  - `vt_get_child_files()` returns the list of files that are indicated in the validation.yml to be included in the 
  validation report. This allows for batch creation of the dynamic content in the report.
  
Keep in mind, the report is an Rmarkdown, so there is no limit to editing and customization, and templates.

## Running a validation report

### Validation Mode: Running on Source

```{r}
valtools::vt_validate_source()
```

### Validation Mode: Generating validated bundle for distribution

```{r}
valtools::vt_validate_build()
```

### Validation Mode: Validating and installing package

```{r}
valtools::vt_validate_install()
```

### Validation Mode: re-validating an installed package

```{r}
valtools::vt_validate_installed_package("example.package")
```

compare this result against the original validation vignette:

```{r}
vignette("validation","example.package")
```
