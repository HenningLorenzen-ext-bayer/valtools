---
title: "Starting New Validation Package using {valtools}"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Starting New Validation Package using {valtools}}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
)
```

```{r setup, warning=FALSE}
# remotes::install_github("phuse-org/valtools")
library(valtools)
```

## Intro

This vignette steps through the process of creating an R package that is intended to be 
validated, by extending `usethis` and `devtools` functionality to provide a 
seamless validation process. 

## Starting a Package

- Create a new R package skeleton
- Add requirements
- Add test cases

```{r}

# create a new package skeleton
vt_create_package(file.path(tempdir(),"example.package"))

```

See how in addition to the normal R package infrastructure, there is now a 
`vignettes/validation` folder, which is the working directory for the 
validation. Inside this, there is a `validation.yml` file. This file is the 
configuration file for validation. It drives a lot of the downstream steps that 
occur during validation.

```{r}

fs::dir_tree(recurse = TRUE)

cat(readLines("vignettes/validation/validation.yml"),sep = "\n")

```


## Requirements

To add the content required for validation, we extended the `usethis` process to
create a family of "vt_use_*" functions.

`vt_use_req()` creates a new requirement. It accepts the name of the requirement, 
and optionally a username. If not passed, valtools will automatically get the username
of the person creating the requirement. If the user has not created any contents 
before, it will ask the user some questions.

```{r}

valtools::vt_use_req("Requirement_001")

```

In the newly opened requirements file, on line 5, Replace `REQUIEMENTS` with `1.1`, and `ASSESSMENT` with `1, Low Risk, Small Impact` to indicate requirement 1.1 has a risk assessment that determined it has a low risk and small impact when it is wrong.

Add a new line underneath the line above (at line 6) line that contains:
`#' 1.2: 5, Low risk, Medium Impact`

Copy the following content:

+ 1.1 Say Hello to users
+ 1.2 Say Hello to multiple users at once


## Package development

At this point, step back into the usual R package development process using 
`usethis` and `devtools` to create the package.

One unique step is to use the custom `@editor` and `@editDate` roxygen tags to 
mark who wrote a function and who edited it last.


```{r function}

usethis::use_r("hello_world")

```

Copy the following code

```r
#' Hello World
#' @param name name to say hello to
#' @returns character string saying hello
#' @editor Ellis Hughes
#' @editDate 2021-03-12
#' @export
hello_world <- function(name){
  paste("Hello,",name)
}
```

```{r}

# generate documentation
devtools::document()

#GPP: unit testing, update DESCRIPTION, ...
```

## Change log

Document updates and changes in validation documentation using the Change Log file. This is valuable for
documenting when changes occurred (version) to the validation and summarizing information for leadership!

```{r}

valtools::vt_use_change_log()

```

## Testing

`vt_use_test_case()` creates a new test case file, and `vt_use_test_code()` 
creates a new test code file. They have the same arguments as `vt_use_req()`.

```{r}

valtools::vt_use_test_case("Test_case_001")

```


Replace `TESTCASE` with `1.1`, and `REQUIREMENT` with `1.1` to indicate test case 1.1 shows that requirement 1.1 is being met.


Add a new line underneath the line above (at line 6) line that contains:
`#' 1.2: 1.1, 1.2`

This is to indicate test case 1.2 shows requirements 1.1 and 1.2 are being met.

Copy the following test case into file where test cases are to be documented:

+ 1.1 test that the software can say "hello, Johnny" by passing a user "Johnny" 
to the hello_world function
+ 1.2 test that the software can say hello to multiple people by passing a vector of users - "Johnny", "Beth", "Andy","Elisabeth"
to the hello_world function and getting back a vector of: c("Hello, Johnny", "Hello, Beth", "Hello, Andy","Hello, Elisabeth")


```{r}

valtools::vt_use_test_code("Test_code_001", username = "Not Ellis")

```


Update `TESTNUMBER` to `1.1` in the new test code file and copy the code below
into the body of the test:

```r

 hello_result <- hello_world("Johnny")
 
 expect_equal(
  hello_result,
  "Hello, Johnny"
 )

```
add a new test with the following beneath the test. Replace "TODAYS DATE" with todays date.

```r

#' @editor Not Ellis
#' @editDate TODAYS DATE
test_that("1.2",{

 hello_result <- hello_world(c("Johnny", "Beth", "Andy","Elisabeth"))
 
 expect_equal(
  hello_result,
  c("Hello, Johnny", "Hello, Beth", "Hello, Andy","Hello, Elisabeth")
 )
})


```

## Generating the Validation Report

Currently the code to `vt_use_report()` is under development, but users can get
around that by using `usethis` to generate the vignette and populate the contents
manually.

```{r}

usethis::use_vignette("validation")

```

We currently have code in `develop` for the following:

- `vt_path()` allows user to base path from the base validation directory
- capture validation environment with `vt_scrape_val_env()`
- record the NEWS.md with `vt_scrape_news()`
- scraping authorship from requirements, functions, test cases and test code
- scraping and generating a traceability matrix
- evaluating test code
- dynamic referencing (Will cover later)


Copy the following into the vignette:

header yaml:

```
---
title: "validation of {example.package}"
date: "`r Sys.time()`"
output: 
  rmarkdown::pdf_document:
vignette: >
  %\VignetteIndexEntry{validation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
header-includes:
  - \usepackage{float}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{longtable}
classoption: dvipsnames
---
```

vignette contents:

``````

```{r, include = FALSE}

options(knitr.table.format = "latex",
        knitr.kable.NA = '',
        width = 40,
        usethis.quiet = TRUE)
        
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  echo = FALSE,
  results = 'asis'
)

library(valtools)
library(testthat)
library(knitr)
library(magrittr)
library(kableExtra)

```

```{r}
library(example.package)
```

## Signatures

```{r}

vt_scrape_sig_table() %>% 
 vt_kable_sig_table()

```

## Validation Environment

```{r}

vt_scrape_val_env() %>% 
  vt_kable_val_env()

```

## Change Log

```{r}

vt_scrape_change_log() %>% 
  vt_kable_change_log()

```

## Authorship

### Requirement Authors

```{r}

vt_scrape_requirements() %>% 
  vt_kable_requirements()

```

### Function Authors

```{r}

vt_scrape_functions() %>% 
  vt_kable_functions()

```

### Test Case Authors

```{r}
test_case_author_list <- vt_scrape_tags_from(type = "test_cases")

kable(do.call('rbind', test_case_author_list))

```

### Test Code Authors

```{r}
test_code_author_list <- vt_scrape_tags_from(type = "test_code")

kable(do.call('rbind', test_code_author_list))

```

## Traceability

```{r}

vt_scrape_coverage_matrix() %>% 
 vt_kable_coverage_matrix

```

## Requirements

```{r}

vt_file(vt_path("requirements","Requirement_001.md"))

```


## Test Cases

```{r}

vt_file(vt_path("test_cases","Test_case_001.md"))

```


## Test Code Results

```{r}

vt_run_test_code_file("Test_code_001.R") %>% 
  vt_kable_test_code()
  

```


``````

## Running a validation report

### Validation Mode: Running on Source

```{r}
valtools::vt_validate_source()
```

### Validation Mode: Generating validated bundle for distribution

```{r}
valtools::vt_validate_build()
```

### Validation Mode: Validating and installing package

```{r}
valtools::vt_validate_install()
```

### Validation Mode: re-validating an installed package

```{r}
valtools::vt_validate_installed_package("example.package")
```

compare this result against the original validation vignette:

```{r}
vignette("validation","example.package")
```
