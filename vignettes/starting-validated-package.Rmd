---
title: "Starting New Validation Package using {valtools}"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Starting New Validation Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=FALSE
)
```

```{r setup, warning=FALSE}
remotes::install_github("phuse-org/valtools")
library(valtools)
```

## Intro

This vignette steps through creating an R package that is intended to be 
validated, by extending `usethis` and `devtools` functionality to provide a 
seamless validation process. 

## Starting a Package

- Create a new R package skeleton
- Add requirements
- Add test cases

```{r}

# create a new package skeleton
vt_create_package(file.path(tempdir(),"example.package"))

```

See how in addition to the normal R package infrastructure, there is a `validation.yml`
file. This file is the configuration file for validation. It drives a lot of the 
downstream steps that occur during validation. Also, there is now a `vignettes/validation`
folder, which is the working directory for the validation.

```{r}

fs::dir_ls()

cat(readLines("validation.yml"),sep = "\n")

```


## Requirements

To add the content required for validation, we extended the `usethis` process to
create a family of "vt_use_*" functions.

`vt_use_req()` creates new requirements. It accepts the name of the requirement, 
and optionally a username. If not passed, valtools will automatically get the username
of the person creating the requirement. If the user has not created any contents 
before, it will ask the user some questions.

```{r}

vt_use_req("Requirement_001")



```

Copy the following content:

+ Say Hello to users


## Package development

At this point, step back into the usual R package development process using 
`usethis` and `devtools` to create the package.

One unique step is to use the custom `@editor` and `@editDate` roxygen tags to 
mark who wrote a function and who edited it last.


```{r function}

usethis::use_r("hello_world")

```

Copy the following code

```r
#' Hello World
#' @param name name to say hello to
#' @returns character string saying hello
#' @editor Ellis Hughes
#' @editDate 2021-03-12
#' @export
hello_world <- function(name){
  paste("Hello,",name)
}
```

```{r}

# generate documentation
devtools::document()

#GPP: unit testing, update DESCRIPTION, ...
```


## Testing

`vt_use_test_case()` creates a new test case file, and `vt_use_test_code()` 
creates a new test code file. They have the same arguments as `vt_use_req()`.

```{r}

vt_use_test_case("Test_case_001")

```

Copy the following test case into the new document:

+ 1.1 test that the software can say "hello, Johnny" by passing a user "Johnny" 
to the hello_world function


```{r}

vt_use_test_code("Test_code_001", username = "Not Ellis")

```


Update `TESTNUMBER` to `1.1` in the new test code file and copy the code below
into the body of the test:

```r

 hello_result <- hello_world("Johnny")
 
 expect_equal(
  hello_result,
  "Hello, Johnny"
 )

```


## Generating the Validation Report

Currently the code to `vt_use_report()` is under development, but users can get
around that by using `usethis` to generate the vignette and populate the contents
manually.

```{r}

usethis::use_vignette("validation")

```

We currently have code in `develop` for the following:

- `vt_path()` allows user to base path from the base validation directory
- capture validation environment
- scraping authorship from requirements, functions, test cases and test code
- evaluating test code
- dynamic referencing (Will cover later)


Copy the following into the vignette:

header yaml:

```
---
title: "validation"
date: "`r Sys.time()`"
output: 
  rmarkdown::pdf_document:
vignette: >
  %\VignetteIndexEntry{validation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
header-includes:
  - \usepackage{float}
  - \usepackage{array}
classoption: dvipsnames
---
```

vignette contents:

``````

```{r, include = FALSE}

options(knitr.table.format = "latex",
        knitr.kable.NA = '',
        width = 40,
        usethis.quiet = TRUE)
        
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = TRUE,
  echo = FALSE,
  results = 'asis'
)

library(valtools)
library(testthat)
library(knitr)
library(magrittr)

```

```{r}
library(example.package)
```

## Validation Environment

```{r}

vt_scrape_val_env() %>% 
  kable()

```

## Authorship

### Requirement Authors

```{r}
requirement_author_list <- vt_scrape_tags_from(type = "requirements")

kable(do.call('rbind', requirement_author_list))

```

### Function Authors

```{r}
function_author_list <- vt_scrape_tags_from(type = "functions")

kable(do.call('rbind', function_author_list))

```

### Test Case Authors

```{r}
test_case_author_list <- vt_scrape_tags_from(type = "requirements")

kable(do.call('rbind', test_case_author_list))

```

### Test Code Authors

```{r}
test_code_author_list <- vt_scrape_tags_from(type = "requirements")

kable(do.call('rbind', test_code_author_list))

```

## Requirements

```{r}

text <- readLines(vt_path("requirements","Requirement_001.md"))

# remove roxygen comment headers
cat(text[!grepl("^#'", text)], sep = "\n")

```


## Test Cases

```{r}

text <- readLines(vt_path("test_cases","Test_case_001.md"))

# remove roxygen comment headers
cat(text[!grepl("^#'", text)], sep = "\n")

```


## Test Code Results

```{r}

vt_run_test_code_file("Test_code_001.R") %>% 
  kable()

```


``````

## Running a validation report

### Validation Mode: Running on Source

```{r}
valtools::vt_validate_source()
```

### Validation Mode: Generating validated bundle for distribution

```{r}
valtools::vt_validate_build()
```

### Validation Mode: Validating and installing package

```{r}
valtools::vt_validate_install()
```

### Validation Mode: re-validating an installed package

```{r}
valtools::vt_validate_installed_package("example.package")
```

compare this result against the original validation vignette:

```{r}
vignette("validation","example.package")
```
